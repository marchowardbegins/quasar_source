'use strict';function EntityManager(){this.__init__();}
EntityManager.prototype={entities:null,public_entities:null,post_delete_entity:null,post_save_entity:null,post_load_user_entities:null,post_load_public_entities:null,user_entities_loaded:null,public_entities_loaded:null,loading:null,all_public_entities_loaded:function(data){l('Got the following data for public entities');l(data);if(is_string(data)){data=eval(data);}
MANAGER_ENTITY.add_public_entity_from_entity_data(data);this.public_entities_loaded=true;if(this.user_entities_loaded){this.all_data_loaded();}},all_user_entities_loaded:function(data){l('Got the following data for user entities');l(data);if(is_string(data)){data=eval(data);}
MANAGER_ENTITY.add_user_entity_from_entity_data(data);this.user_entities_loaded=true;this.set_owner_entity();if(this.public_entities_loaded){this.all_data_loaded();}},all_data_loaded:function(){MANAGER_ENTITY.link_entities();this.loading=false;},delete_all_children_of_entity_that_do_not_have_other_parents:function(parent_entity){for(var c=parent_entity.children.length;c--;){var child_entity=parent_entity.children[c];child_entity.remove_parent(parent_entity);if(child_entity.number_of_parents()===0){this.delete_entity(child_entity);}}},entity_deleted_response:function(data){if(data===SERVER_REPLY_GENERIC_YES){l('Entity deleted!');}else{l('Entity did not get deleted : {|'+data+'|}');}},delete_entity:function(entity){var entity_to_delete=null;var index_to_splice=this._get_index_of_entity(entity);if(index_to_splice!==NOT_FOUND){entity_to_delete=this.entities[index_to_splice];}else{raise_exception('Entity to delete was not found!');}
if(entity_to_delete!==null){this.delete_all_children_of_entity_that_do_not_have_other_parents(entity_to_delete);var data={};data[ENTITY_PROPERTY_USERNAME]=CURRENT_PLAYER.get_username();data[ENTITY_PROPERTY_PASSWORD]=CURRENT_PLAYER.get_password();data[ENTITY_DEFAULT_PROPERTY_RELATIVE_ID]=entity_to_delete.get_relative_id();this.post_delete_entity.perform_post(data,this.entity_deleted_response.bind(this));}
if(index_to_splice!==NOT_FOUND){this.entities.splice(this._get_index_of_entity(entity),1);}},__init__:function(){this.entities=[];this.public_entities=[];this.user_entities_loaded=false;this.public_entities_loaded=false;this.loading=false;this.post_delete_entity=new PostHelper('/delete_entity');this.post_save_entity=new PostHelper('/save_entity');this.post_load_user_entities=new PostHelper('/get_user_entities');this.post_load_public_entities=new PostHelper('/get_public_entities');},set_owner_entity:function(){},load_data:function(){this.loading=true;var data={};data[ENTITY_PROPERTY_USERNAME]=ENTITY_OWNER.get_username();data[ENTITY_PROPERTY_PASSWORD]=ENTITY_OWNER.get_password();this.post_load_user_entities.perform_post(data,this.all_user_entities_loaded.bind(this));this.post_load_public_entities.perform_post({},this.all_public_entities_loaded.bind(this));},link_entities:function(){for(var e=0;e<this.entities.length;e++){var children_ids=this.entities[e].get_child_ids();var parent_ids=this.entities[e].get_parent_ids();for(var c=0;c<children_ids.length;c++){this.entities[e].add_child(this.get_entity_by_id(children_ids[c]));}
for(var p=0;p<parent_ids.length;p++){this.entities[e].add_parent(this.get_entity_by_id(parent_ids[p]));}}},get_new_entity_id:function(){var max_id=-1;for(var i=0;i<this.entities.length;i++){var entity_id=this.entities[i].get_relative_id();if(entity_id>max_id){max_id=entity_id;}}
return max_id+1;},get_all_entities_of_type:function(entity_type){var entities_to_return=[];for(var i=0;i<this.entities.length;i++){if(this.entities[i].get_type()===entity_type){entities_to_return.push(this.entities[i]);}}
return entities_to_return;},currently_loading:function(){return this.loading;},is_property_user_modifiable:function(property){switch(property){case ENTITY_DEFAULT_PROPERTY_CHILD_IDS:case ENTITY_DEFAULT_PROPERTY_TYPE:case ENTITY_DEFAULT_PROPERTY_PARENT_IDS:case ENTITY_DEFAULT_PROPERTY_RELATIVE_ID:return false;default:return true;}},clear_all:function(){this.user_entities_loaded=false;this.public_entities_loaded=false;this.entities.length=0;},add_entity_if_not_already_added:function(entity){if(entity.has_property(ENTITY_PROPERTY_PUBLIC)){for(var i=0;i<this.public_entities.length;i++){if(this.public_entities[i].get_relative_id()===entity.get_relative_id()){return;}}
this.public_entities.push(entity);}else{for(var j=0;j<this.entities.length;j++){if(this.entities[j].get_relative_id()===entity.get_relative_id()){return;}}
this.entities.push(entity);}},_get_index_of_entity:function(entity){for(var i=0;i<this.entities.length;i++){if(this.entities[i].get_relative_id()===entity.get_relative_id()){return i;}}
return NOT_FOUND;},delete_entity_by_id:function(entity_id){var entity=this.get_entity_by_id(entity_id);if(entity!==null){this.delete_entity(entity);}else{l('No Entity found for the ID{'+entity_id+'}');}},add_user_entity_from_entity_data:function(entity_data){return new Entity(entity_data);},add_public_entity_from_entity_data:function(entity_data){return new Entity(entity_data);},get_all_entities:function(){return this.entities;},get_owner_entity:function(){return this.get_all_entities_of_type(ENTITY_TYPE_OWNER)[0];},get_entity_by_id:function(entity_id){var match_found_ONLY_FOR_DEBUGGING=false;for(var i=0;i<this.entities.length;i++){if(this.entities[i].get_relative_id()===entity_id){match_found_ONLY_FOR_DEBUGGING=true;return this.entities[i];}}
if(!match_found_ONLY_FOR_DEBUGGING){l('MATCH NOT FOUND FOR :');l(entity_id);throw_exception('Entity ID match not found!');}
return null;},save_changes_result:function(){if(arguments[1]===SERVER_REPLY_GENERIC_YES){arguments[0].needs_to_be_saved=false;}else{l('Error saving entity : ');l(arguments[0]);}},update_server_and_database:function(){var username=ENTITY_OWNER.get_username();var password=ENTITY_OWNER.get_password();for(var e=0;e<this.entities.length;e++){if(this.entities[e].needs_to_be_saved){var data={};data[ENTITY_PROPERTY_USERNAME]=username;data[ENTITY_PROPERTY_PASSWORD]=password;data['save_data']=JSON.stringify(this.entities[e].get_all_properties());this.post_save_entity.perform_post(data,this.save_changes_result.bind(this,this.entities[e]));}}}};