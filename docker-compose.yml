# The version of the Docker compose file format to use.
version: '3.7'

services:

  # RabbitMQ broker.
  rabbit:
    image: rabbitmq:3.6.9-management-alpine
    hostname: rabbit
    ports:
      - "5672:5672"
      - "8000:15672"
    networks:
      - rabbitmq_network

  # Serves static content and forwards requests to servers.
  nginx:
    build:
      context: .
      dockerfile: ./applications/nginx/Dockerfile
    tty: true
    ports:
      - "80:80"
      - "3000:3000"
    volumes:
      - ./:/quasar
    depends_on:
      - websocket

  nexus_server:
    build:
      context: .
      dockerfile: ./applications/nexus_server/Dockerfile
    environment:
      - CLUSTERED=true
      - CLUSTER_WITH=rabbit1
    ports:
      - "5673:5672"
      - "8001:15672"
    hostname: nexus_server
    tty: true
    volumes:
      - ./:/quasar
    depends_on:
      - rabbit
    networks:
      - rabbitmq_network

  # TODO: Naming
  websocket:
    build:
      context: .
      dockerfile: ./applications/nexus_courier/Dockerfile
    tty: true
    #ports:
    #  - "3001:3001"
    volumes:
      - ./:/quasar
    #depends_on:
    #  - nginx

  # Local development 3D web interface.
#  nexus_local:
#    build: ./applications/nexus_courier/local
#    environment:
#      - DJANGO_SECRET_KEY=gvb9f175igbse7329ei3pl72p73fehn8g2opwtetc2ihh4325a
#      - SQLITE_DB_PATH=/quasar/generated_output/local/nexus_local_db.sqlite
#      - PYTHONPATH=:/quasar
#      - DJANGO_SETTINGS_MODULE=nexus_local.settings
#    tty: true
#    ports:
#      - "1337:1337"
#    volumes:
#      - ./:/quasar
#    depends_on:
#      - redis
#      - nginx

  # Needed for Django Channels (web-sockets).
#  redis:
#    build: ./applications/redis/
#    command: redis-server
#    tty: true
#    ports:
#      - "6379:6379"
#    volumes:
#      - 'redis_data:/data'

#  nexus_server_temp:
#    build:
#      context: .
#      dockerfile: ./applications/nexus_server_temp/Dockerfile
#    environment:
#      - CLUSTERED=true
#      - CLUSTER_WITH=rabbit1
#    ports:
#      - "5674:5672"
#      - "8002:15672"
#    tty: true
#    hostname: nexus_server_temp
#    volumes:
#      - ./:/quasar
#    depends_on:
#      - rabbit1
#    networks:
#      - rabbitmq_network

volumes:
  redis_data:

networks:
  rabbitmq_network:

#websocket_server